generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Alliance {
  id                      Int                @id
  name                    String
  createdAt               DateTime           @default(now()) @map("created_at")
  updatedAt               DateTime           @updatedAt @map("updated_at")
  crossAllianceAidSources CrossAllianceAid[] @relation("SourceAlliance")
  crossAllianceAidTargets CrossAllianceAid[] @relation("TargetAlliance")
  nations                 Nation[]
  events                  Event[]
  managers                UserAllianceManager[]

  @@map("alliances")
}

model Nation {
  id                                                     Int            @id
  rulerName                                              String         @map("ruler_name")
  nationName                                             String         @map("nation_name")
  allianceId                                             Int            @map("alliance_id")
  team                                                   String
  strength                                               Float
  activity                                               String
  technology                                             String
  infrastructure                                         String
  land                                                   String
  nuclearWeapons                                         Int            @default(0) @map("nuclear_weapons")
  governmentType                                         String         @map("government_type")
  inWarMode                                              Boolean        @default(false) @map("in_war_mode")
  attackingCasualties                                    Int?           @map("attacking_casualties")
  defensiveCasualties                                    Int?           @map("defensive_casualties")
  warchest                                               Float?
  spyglassLastUpdated                                    Int?           @map("spyglass_last_updated")
  rank                                                   Int?
  createdAt                                              DateTime       @default(now()) @map("created_at")
  updatedAt                                              DateTime       @updatedAt @map("updated_at")
  firstSeenAt                                            DateTime       @default(now()) @map("first_seen_at")
  isActive                                                Boolean        @default(true) @map("is_active")
  lastSeenAt                                              DateTime       @default(now()) @map("last_seen_at")
  declaringAidOffers                                     AidOffer[]     @relation("DeclaringNation")
  receivingAidOffers                                     AidOffer[]     @relation("ReceivingNation")
  dynamic_wars_dynamic_wars_declaring_nation_idTonations dynamic_wars[] @relation("dynamic_wars_declaring_nation_idTonations")
  dynamic_wars_dynamic_wars_receiving_nation_idTonations dynamic_wars[] @relation("dynamic_wars_receiving_nation_idTonations")
  nationConfig                                           NationConfig?
  alliance                                               Alliance       @relation(fields: [allianceId], references: [id])
  declaringWars                                          War[]          @relation("DeclaringNation")
  receivingWars                                          War[]          @relation("ReceivingNation")
  events                                                 Event[]
  casualtyRankingSnapshots                               CasualtyRankingSnapshot[]
  warchestSubmissions                                    WarchestSubmission[]

  @@index([allianceId])
  @@index([id])
  @@index([isActive])
  @@index([lastSeenAt])
  @@map("nations")
}

model NationConfig {
  id              Int      @id @default(autoincrement())
  nationId        Int      @unique @map("nation_id")
  hasDra          Boolean  @default(false) @map("has_dra")
  discordHandle   String?  @map("discord_handle")
  notes           String?
  sendTechSlots   Int      @default(0) @map("send_tech_slots")
  sendCashSlots   Int      @default(0) @map("send_cash_slots")
  getTechSlots    Int      @default(0) @map("get_tech_slots")
  getCashSlots    Int      @default(0) @map("get_cash_slots")
  externalSlots   Int      @default(0) @map("external_slots")
  sendPriority    Int      @default(3) @map("send_priority")
  receivePriority Int      @default(3) @map("receive_priority")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  nation          Nation   @relation(fields: [nationId], references: [id], onDelete: Cascade)

  @@index([nationId])
  @@map("nation_configs")
}

model AidOffer {
  aidId               Int      @id @map("aid_id")
  declaringNationId   Int      @map("declaring_nation_id")
  receivingNationId   Int      @map("receiving_nation_id")
  declaringAllianceId Int?     @map("declaring_alliance_id")
  receivingAllianceId Int?     @map("receiving_alliance_id")
  status              String
  money               Float    @default(0)
  technology          Float    @default(0)
  soldiers            Int      @default(0)
  date                String   @map("aid_timestamp")
  reason              String
  isExpired           Boolean? @default(false) @map("is_expired")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  firstSeenAt         DateTime @default(now()) @map("first_seen_at")
  isActive            Boolean  @default(true) @map("is_active")
  lastSeenAt          DateTime @default(now()) @map("last_seen_at")
  version             Int      @default(1)
  declaringNation     Nation   @relation("DeclaringNation", fields: [declaringNationId], references: [id])
  receivingNation      Nation   @relation("ReceivingNation", fields: [receivingNationId], references: [id])

  @@index([declaringNationId])
  @@index([receivingNationId])
  @@index([declaringAllianceId])
  @@index([receivingAllianceId])
  @@index([status])
  @@index([isActive])
  @@index([lastSeenAt])
  @@map("aid_offers")
}

model War {
  warId               Int      @id @map("war_id")
  declaringNationId   Int      @map("declaring_nation_id")
  receivingNationId   Int      @map("receiving_nation_id")
  declaringAllianceId Int?     @map("declaring_alliance_id")
  receivingAllianceId Int?     @map("receiving_alliance_id")
  status              String
  date                String
  endDate             String   @map("end_date")
  reason              String?
  destruction         String?
  attackPercent       Float?   @map("attack_percent")
  defendPercent       Float?   @map("defend_percent")
  formattedEndDate    String?  @map("formatted_end_date")
  daysUntilExpiration Int?     @map("days_until_expiration")
  expirationColor     String?  @map("expiration_color")
  isExpired           Boolean? @default(false) @map("is_expired")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  firstSeenAt         DateTime @default(now()) @map("first_seen_at")
  isActive            Boolean  @default(true) @map("is_active")
  lastSeenAt          DateTime @default(now()) @map("last_seen_at")
  version             Int      @default(1)
  declaringNation     Nation   @relation("DeclaringNation", fields: [declaringNationId], references: [id])
  receivingNation     Nation   @relation("ReceivingNation", fields: [receivingNationId], references: [id])

  @@index([declaringNationId])
  @@index([receivingNationId])
  @@index([declaringAllianceId])
  @@index([receivingAllianceId])
  @@index([status])
  @@index([isActive])
  @@index([lastSeenAt])
  @@map("wars")
}

model NuclearHit {
  id              Int      @id @default(autoincrement())
  key             String   @unique
  attackingNation String   @map("attacking_nation")
  defendingNation String   @map("defending_nation")
  result          String?
  sentAt          String   @map("sent_at")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([key])
  @@map("nuclear_hits")
}

model CrossAllianceAid {
  id               Int      @id @default(autoincrement())
  sourceAllianceId Int      @map("source_alliance_id")
  targetAllianceId Int      @map("target_alliance_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  sourceAlliance   Alliance @relation("SourceAlliance", fields: [sourceAllianceId], references: [id])
  targetAlliance   Alliance @relation("TargetAlliance", fields: [targetAllianceId], references: [id])

  @@unique([sourceAllianceId, targetAllianceId])
  @@index([sourceAllianceId])
  @@index([targetAllianceId])
  @@map("cross_alliance_aid")
}

model FileDownload {
  fileType     String   @id @map("file_type")
  originalFile String   @map("original_file")
  timestamp    BigInt
  downloadTime DateTime @map("download_time")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("file_downloads")
}

model AllianceAidUtilizationSnapshot {
  allianceId            BigInt   @map("alliance_id")
  allianceName          String   @map("alliance_name")
  totalAidOffers        Int      @default(0) @map("total_aid_offers")
  totalNations          Int      @default(0) @map("total_nations")
  aidUtilizationPercent Decimal  @default(0.00) @map("aid_utilization_percent") @db.Decimal(5, 2)
  snapshotDate          DateTime @map("snapshot_date") @db.Date

  @@id([allianceId, snapshotDate])
  @@map("alliance_aid_utilization_snapshots")
}

model dynamic_wars {
  id                                                Int      @id @default(autoincrement())
  war_id                                            Int      @unique
  declaring_nation_id                               Int
  receiving_nation_id                               Int
  status                                            String
  date                                              String
  end_date                                          String
  reason                                            String?
  destruction                                       String?
  attack_percent                                    Float?
  defend_percent                                    Float?
  added_at                                          DateTime
  source                                            String
  created_at                                        DateTime @default(now())
  updated_at                                        DateTime
  nations_dynamic_wars_declaring_nation_idTonations Nation   @relation("dynamic_wars_declaring_nation_idTonations", fields: [declaring_nation_id], references: [id])
  nations_dynamic_wars_receiving_nation_idTonations Nation   @relation("dynamic_wars_receiving_nation_idTonations", fields: [receiving_nation_id], references: [id])

  @@index([declaring_nation_id])
  @@index([receiving_nation_id])
  @@index([status])
}

model Event {
  id          Int       @id @default(autoincrement())
  type        String    // 'nation' or 'alliance'
  eventType   String    @map("event_type") // e.g., 'new_nation', 'nation_inactive'
  nationId    Int?      @map("nation_id")
  allianceId  Int?      @map("alliance_id")
  description String
  metadata    Json?     // Additional data as JSON
  createdAt   DateTime  @default(now()) @map("created_at")
  nation      Nation?   @relation(fields: [nationId], references: [id], onDelete: Cascade)
  alliance    Alliance? @relation(fields: [allianceId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([eventType])
  @@index([nationId])
  @@index([allianceId])
  @@index([createdAt])
  @@map("events")
}

model CasualtyRankingSnapshot {
  id                 Int      @id @default(autoincrement())
  snapshotDate       DateTime @map("snapshot_date")
  nationId            Int      @map("nation_id")
  rank                Int
  totalCasualties     Int      @map("total_casualties")
  attackingCasualties Int      @map("attacking_casualties")
  defensiveCasualties Int      @map("defensive_casualties")
  createdAt           DateTime @default(now()) @map("created_at")
  nation              Nation   @relation(fields: [nationId], references: [id], onDelete: Cascade)

  @@index([snapshotDate])
  @@index([nationId])
  @@index([snapshotDate, rank])
  @@map("casualty_ranking_snapshots")
}

enum UserRole {
  ADMIN
  ALLIANCE_MANAGER
  WAR_MANAGER
  USER
}

model User {
  id               Int                  @id @default(autoincrement())
  googleId         String               @unique @map("google_id")
  email            String               @unique
  rulerName        String?              @unique @map("ruler_name")
  role             UserRole             @default(USER)
  createdAt        DateTime             @default(now()) @map("created_at")
  updatedAt        DateTime             @updatedAt @map("updated_at")
  managedAlliances UserAllianceManager[]

  @@map("users")
}

model UserAllianceManager {
  userId     Int      @map("user_id")
  allianceId Int      @map("alliance_id")
  createdAt  DateTime @default(now()) @map("created_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  alliance   Alliance @relation(fields: [allianceId], references: [id], onDelete: Cascade)

  @@id([userId, allianceId])
  @@index([userId])
  @@index([allianceId])
  @@map("user_alliance_managers")
}

model WarchestSubmission {
  id          Int      @id @default(autoincrement())
  nationId    Int?     @map("nation_id")
  nationName  String   @map("nation_name")
  totalMoney  Float    @map("total_money")
  capturedAt  DateTime @map("captured_at")
  createdAt   DateTime @default(now()) @map("created_at")
  nation      Nation?  @relation(fields: [nationId], references: [id], onDelete: SetNull)

  @@index([nationId])
  @@index([nationName])
  @@index([capturedAt])
  @@map("warchest_submissions")
}

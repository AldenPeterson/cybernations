// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Alliance {
  id        Int      @id
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  nations                 Nation[]
  crossAllianceAidSources CrossAllianceAid[] @relation("SourceAlliance")
  crossAllianceAidTargets CrossAllianceAid[] @relation("TargetAlliance")

  @@map("alliances")
}

model Nation {
  id                  Int      @id
  rulerName           String   @map("ruler_name")
  nationName          String   @map("nation_name")
  allianceId          Int      @map("alliance_id")
  team                String
  strength            Float
  activity            String
  technology          String
  infrastructure      String
  land                String
  nuclearWeapons      Int      @default(0) @map("nuclear_weapons")
  governmentType      String   @map("government_type")
  inWarMode           Boolean  @default(false) @map("in_war_mode")
  attackingCasualties Int?     @map("attacking_casualties")
  defensiveCasualties Int?     @map("defensive_casualties")
  warchest            Float?
  spyglassLastUpdated Int?     @map("spyglass_last_updated")
  rank                Int?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  alliance             Alliance      @relation(fields: [allianceId], references: [id])
  nationConfig         NationConfig?
  declaringAidOffers   AidOffer[]    @relation("DeclaringNation")
  receivingAidOffers   AidOffer[]    @relation("ReceivingNation")
  declaringWars        War[]         @relation("DeclaringNation")
  receivingWars        War[]         @relation("ReceivingNation")

  @@index([allianceId])
  @@index([id])
  @@map("nations")
}

model NationConfig {
  id              Int      @id @default(autoincrement())
  nationId        Int      @unique @map("nation_id")
  hasDra          Boolean  @default(false) @map("has_dra")
  discordHandle   String?  @map("discord_handle")
  notes           String?
  sendTechSlots   Int      @default(0) @map("send_tech_slots")
  sendCashSlots   Int      @default(0) @map("send_cash_slots")
  getTechSlots    Int      @default(0) @map("get_tech_slots")
  getCashSlots    Int      @default(0) @map("get_cash_slots")
  externalSlots   Int      @default(0) @map("external_slots")
  sendPriority    Int      @default(3) @map("send_priority")
  receivePriority Int      @default(3) @map("receive_priority")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  nation Nation @relation(fields: [nationId], references: [id], onDelete: Cascade)

  @@index([nationId])
  @@map("nation_configs")
}

model AidOffer {
  aidId               Int      @id @map("aid_id")
  declaringNationId   Int      @map("declaring_nation_id")
  receivingNationId   Int      @map("receiving_nation_id")
  status              String
  money               Float    @default(0)
  technology          Float    @default(0)
  soldiers            Int      @default(0)
  date                String
  reason              String
  isExpired           Boolean? @default(false) @map("is_expired")
  // Historical tracking fields
  firstSeenAt         DateTime @default(now()) @map("first_seen_at")
  lastSeenAt          DateTime @default(now()) @map("last_seen_at")
  isActive            Boolean  @default(true) @map("is_active")
  version             Int      @default(1)
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  declaringNation Nation @relation("DeclaringNation", fields: [declaringNationId], references: [id])
  receivingNation Nation @relation("ReceivingNation", fields: [receivingNationId], references: [id])

  @@index([declaringNationId])
  @@index([receivingNationId])
  @@index([status])
  @@index([isActive])
  @@index([lastSeenAt])
  @@map("aid_offers")
}

model War {
  warId               Int      @id @map("war_id")
  declaringNationId   Int      @map("declaring_nation_id")
  receivingNationId   Int      @map("receiving_nation_id")
  status              String
  date                String
  endDate             String   @map("end_date")
  reason              String?
  destruction         String?
  attackPercent       Float?   @map("attack_percent")
  defendPercent       Float?   @map("defend_percent")
  formattedEndDate    String?  @map("formatted_end_date")
  daysUntilExpiration Int?     @map("days_until_expiration")
  expirationColor     String?  @map("expiration_color")
  isExpired           Boolean? @default(false) @map("is_expired")
  // Historical tracking fields
  firstSeenAt         DateTime @default(now()) @map("first_seen_at")
  lastSeenAt          DateTime @default(now()) @map("last_seen_at")
  isActive            Boolean  @default(true) @map("is_active")
  version             Int      @default(1)
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  declaringNation Nation @relation("DeclaringNation", fields: [declaringNationId], references: [id])
  receivingNation Nation @relation("ReceivingNation", fields: [receivingNationId], references: [id])

  @@index([declaringNationId])
  @@index([receivingNationId])
  @@index([status])
  @@index([isActive])
  @@index([lastSeenAt])
  @@map("wars")
}


model NuclearHit {
  id              Int      @id @default(autoincrement())
  key             String   @unique
  attackingNation String   @map("attacking_nation")
  defendingNation String   @map("defending_nation")
  result          String?
  sentAt          String   @map("sent_at")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([key])
  @@map("nuclear_hits")
}

model CrossAllianceAid {
  id               Int      @id @default(autoincrement())
  sourceAllianceId Int      @map("source_alliance_id")
  targetAllianceId Int      @map("target_alliance_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  sourceAlliance Alliance @relation("SourceAlliance", fields: [sourceAllianceId], references: [id])
  targetAlliance Alliance @relation("TargetAlliance", fields: [targetAllianceId], references: [id])

  @@unique([sourceAllianceId, targetAllianceId])
  @@index([sourceAllianceId])
  @@index([targetAllianceId])
  @@map("cross_alliance_aid")
}

model FileDownload {
  fileType     String   @id @map("file_type") // Nation_Stats, Aid_Stats, War_Stats
  originalFile String   @map("original_file")
  timestamp    BigInt   // Unix timestamp in milliseconds
  downloadTime DateTime @map("download_time")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("file_downloads")
}
